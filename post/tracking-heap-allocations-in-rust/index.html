<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="Robert Vally" name="author">
<meta property="og:title" content="Make your own quick, &#34;simple&#34; and portable heap allocation tracker in Rust">
<meta property="og:url" content="https://shiver.github.io/post/tracking-heap-allocations-in-rust/">
<meta property="og:description" content="Introduction Besides altering your algorithms, another easy way to improve the performance of your code is by reducing heap allocations. Compared to the heap, stack allocations are significantly faster to both allocate and free, as they are usually done by simply updating a pointer, potentially in a single operation, and often by a dedicated CPU register.
The heap on the other hand is a complicated beast. There is a fair amount of bookkeeping involved when acquiring and potentially releasing memory for your application, and avoiding this overhead will usually net you some decent performance gains, especially if these are happening frequently in your code.">
<meta property="og:type" content="website" />
<title>Make your own quick, &#34;simple&#34; and portable heap allocation tracker in Rust | Learn Everything</title>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Karla:wght@300;400;800&display=swap" rel="stylesheet">


<link rel="shortcut icon" href="https://shiver.github.io//favicon.ico">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/gruvbox-dark-hard.min.css">


<link rel="stylesheet" href="https://shiver.github.io//css/style.css">

</head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://shiver.github.io/"><h1 class="back is-4">ðŸ¡ </h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level">
          
          <a class="level-item" href="https://github.com/shiver" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/shivernz" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml" target="_blank">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Make your own quick, &#34;simple&#34; and portable heap allocation tracker in Rust</h1>
    <h2 class="subtitle">August 25, 2022 by Robert Vally</h2>
    
      <div class="tags">
    
        <a class="is-link" href="/tags/rust">rust</a>
    
        <a class="is-link" href="/tags/profiling">profiling</a>
    
</div>

    
    <hr>
    <div class="content">
      <h2 id="introduction">Introduction</h2>
<p>Besides altering your algorithms, another easy way to improve the performance of your code is by reducing heap allocations. Compared to the heap, stack allocations are significantly faster to both allocate and free, as they are usually done by simply updating a pointer, potentially in a single operation, and often by a dedicated CPU register.</p>
<p>The heap on the other hand is a <a href="https://www.jamesgolick.com/2013/5/15/memory-allocators-101.html">complicated</a> beast. There is a fair amount of bookkeeping involved when acquiring and potentially releasing memory for your application, and avoiding this overhead will usually net you some decent performance gains, especially if these are happening frequently in your code.</p>
<p>Importantly Rust is a systems programming language, albeit with a slight <a href="https://rustc-dev-guide.rust-lang.org/borrow_check.html">twist</a>. One of the important aspects of systems programming languages is that you usually have to pay a little more attention to memory than you otherwise would in a language where memory is managed for you. Given the &ldquo;modern&rdquo; feel that Rust has, it can sometimes be surprising how and where memory is being used, especially for those new to these types of languages, or perhaps just uninitiated with the idiosyncrasies of Rust itself.</p>
<p>To hopefully demystify this subject a little, we&rsquo;re going to delve into Rust&rsquo;s memory allocators, replace the default global allocator, whilst adding a bit of instrumentation to surface where and when allocations are issued.</p>
<p>Obviously this will not be a full robust solution we&rsquo;re developing here, but more of an introduction into the topic, and one that you can choose to venture further with if you so wish.</p>
<p>It should go without saying there are likely (definitely) better options out there. Ones that are more robust, with fewer bugs and fully featured, but writing our own gives us some exposure to the inner workings of the Rust standard library, and also an understanding as to why the alternatives might be better or worse than our simple solution.</p>
<p>Blindly reaching for a dependency when you don&rsquo;t fully understand the problem you&rsquo;re solving, let alone the solution, is not a good habit in my opinion.  Understanding the benefits and drawbacks of your dependency choices is an often overlooked skill that you should always seek to exercise as a software developer. And how can you possibly do that if you never look behind the curtain?</p>
<p>For those who don&rsquo;t want to go through the exercise, or who just want to see the code in its final form before going through the steps below, you can take a look at this <a href="https://gist.github.com/shiver/87ccd945ea62626ed40531b974988da6">gist</a>.</p>
<p>Onwards&hellip;</p>
<h2 id="how-to-replace-the-global-allocator">How to replace the global allocator</h2>
<p>Firstly, the global allocator can be replaced by simply adding the <code>#[global_allocator]</code> annotation to your allocator of choice:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::alloc::{System};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[global_allocator]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> GLOBAL_ALLOCATOR: <span style="color:#a6e22e">System</span> <span style="color:#f92672">=</span> System;
</span></span></code></pre></div><p>This bit of code is clearly redundant as we are simply setting the global allocator back to the default <code>System</code> allocator. This usually happens regardless, but now you know how it is done.</p>
<h2 id="making-our-very-own-allocator">Making our very own allocator</h2>
<p>First off we need to make our own allocator type. We&rsquo;ll call it <code>InstrumentedAllocator</code>!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">InstrumentedAllocator</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(T);
</span></span></code></pre></div><p>You&rsquo;ve probably noticed that our allocator is a generic type, with a single field holding that generic type. We will cover the reason for this in a little bit.</p>
<p>Up next we need to implement <code>GlobalAlloc</code> for our struct. This is a mandatory trait that all global allocators must implement for us to be able to successfully annotate our allocator with <code>#[global_allocator]</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">impl</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> GlobalAlloc <span style="color:#66d9ef">for</span> InstrumentedAllocator<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span>
</span></span><span style="display:flex;"><span>    T: <span style="color:#a6e22e">GlobalAlloc</span>,
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(<span style="color:#f92672">&amp;</span>self, layout: <span style="color:#a6e22e">Layout</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {}
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">dealloc</span>(<span style="color:#f92672">&amp;</span>self, ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span>, layout: <span style="color:#a6e22e">Layout</span>) {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There are just a couple of mandatory functions (<code>alloc</code> and <code>dealloc</code>) which the <code>GlobalAlloc</code> trait requires we implement. I think their purposes are fairly self-explanatory. One acquires the memory, the other releases it.</p>
<p>To answer the question from before, &ldquo;why is our allocator a generic type&rdquo;,  we can see now that we want to to store something that implements <code>GlobalAlloc</code> in our type. Why would we need to store <em>another</em> <code>GlobalAlloc</code> in our allocator that is already implementing <code>GlobalAlloc</code>?</p>
<p>The answer is that we need some way to actually allocate memory. We <em>could</em> write all the allocation code ourselves, but the purpose of this exercise is only to instrument allocations. So to keep this simple we will use the system allocator to do the heavy lifting for us:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">#[global_allocator]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> ALLOCATOR: <span style="color:#a6e22e">InstrumentedAllocator</span><span style="color:#f92672">&lt;</span>System<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> InstrumentedAllocator(System);
</span></span></code></pre></div><p>It is worth noting that by using the system allocator we are avoiding portability issues. Out of the box the system allocator supports all the different platforms that Rust runs on. If we wrote our own memory allocator we would need to take those different platforms into consideration! Definitely out of scope for now.</p>
<h2 id="implementing-alloc">Implementing <code>alloc</code></h2>
<p>Our code obviously won&rsquo;t compile yet:</p>
<pre tabindex="0"><code class="language-rust_errors" data-lang="rust_errors">   |
12 |     unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
   |               -----                           ^^^^^^^ expected *-ptr, found `()`
   |               |
   |               implicitly returns `()` as its body has no tail or `return` expression
   |
   = note: expected raw pointer `*mut u8`
                found unit type `()`
</code></pre><p>We first need to provide implementations for our trait functions.  We&rsquo;ll start with <code>alloc</code>.</p>
<p>This function takes just one parameter which is the desired <a href="https://doc.rust-lang.org/std/alloc/struct.Layout.html">layout</a> of the memory being requested, and in response will return a mutable pointer to the start of our block of bytes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(<span style="color:#f92672">&amp;</span>self, layout: <span style="color:#a6e22e">Layout</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> self.<span style="color:#ae81ff">0.</span>alloc(layout);
</span></span><span style="display:flex;"><span>	ptr
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>About the only thing in here that might need a bit of an explanation is the use of <code>self.0.alloc</code>. Since our struct definition uses an unnamed field, we need to refer to it by its <em>position</em>, rather than by its <em>name</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">InstrumentedAllocator</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>(T);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//  self.0 refers to this field ----^
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// The code below is equivaltent to the line above. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// The code below won&#39;t compile though, since it is against the rules to use 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// pure numbers for field names.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">InstrumentedAllocator</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pub</span> T <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So what <code>self.0.alloc(layout)</code> is saying is simply that we are calling <code>alloc()</code> on the type that is set to that first field in our struct, which just so happens to be a generic type. In our case this generic type is the system allocator, since that is what we passed in earlier:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> ALLOCATOR: <span style="color:#a6e22e">InstrumentedAllocator</span><span style="color:#f92672">&lt;</span>System<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> InstrumentedAllocator(System);
</span></span></code></pre></div><p>Hopefully that clears everything up. Regardless, onto <code>dealloc</code>&hellip;</p>
<h2 id="implementing-dealloc">Implementing <code>dealloc</code></h2>
<p>Much like <code>alloc</code>, <code>dealloc</code> is very simple for us to implement:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">dealloc</span>(<span style="color:#f92672">&amp;</span>self, ptr: <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span>, layout: <span style="color:#a6e22e">Layout</span>) {
</span></span><span style="display:flex;"><span>	self.<span style="color:#ae81ff">0.</span>dealloc(ptr, layout)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There isn&rsquo;t much to explain here, other than we are expecting to pass in the same raw pointer we received from our call to <code>alloc</code> along with the <code>Layout</code>. Once again we are calling the system <code>dealloc</code> function, and then calling it a day.</p>
<p>And with that, we now should have a working allocator. If we stick something simple in <code>main</code> we can confirm that things are working.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Try something that we know will allocate on the heap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> s <span style="color:#f92672">=</span> String::from(<span style="color:#e6db74">&#34;Hello, Clarice!&#34;</span>);
</span></span><span style="display:flex;"><span>	println!(<span style="color:#e6db74">&#34;{}&#34;</span>, s);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Success!</p>
<pre tabindex="0"><code class="language-rust_errors" data-lang="rust_errors">Finished dev [unoptimized + debuginfo] target(s) in 1.64s
     Running `target/debug/playground`
Hello, Clarice!
</code></pre><p>Obviously there is nothing new happening yet, but this just proves that our new allocator is working as it should.</p>
<p>On to the interesting stuff&hellip;</p>
<h2 id="instrumentation">Instrumentation</h2>
<p>Ok, with the ground work done (the allocation), we can now start to work on instrumenting that allocation with a bit of information. Lets just add a simple print to STDOUT with the number of bytes we&rsquo;ve allocated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(<span style="color:#f92672">&amp;</span>self, layout: <span style="color:#a6e22e">Layout</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> self.<span style="color:#ae81ff">0.</span>alloc(layout);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	println!(<span style="color:#e6db74">&#34;{} bytes&#34;</span>, layout.size());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	ptr
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre tabindex="0"><code class="language-rust_errors" data-lang="rust_errors">error: process didn&#39;t exit successfully: `target\debug\alloc.exe` (exit code: 0xc0000005, STATUS_ACCESS_VIOLATION)
</code></pre><p>Uh, what? How does a <code>println!</code> cause a panic?</p>
<p>It is actually fairly simple if you think about it. While allocating the memory we are trying to call <code>println!</code>. Given that the string we&rsquo;re trying to display is constructed at runtime, we first need to allocate some memory for that string before we can write to it. Of course, this will need to call the global allocator to request that extra bit of memory. Wait. We&rsquo;re the global allocator! So we call our own <code>alloc</code> function <em>again</em>, which then calls <code>println!</code> <em>again</em>, which then needs to call <code>alloc</code> <em>again</em>&hellip; I think you get the picture.</p>
<p>What we have here is an infinite loop of allocations which we need to somehow break if we are going to be able to call <code>println!</code> from within our allocator.</p>
<p>The simplest way to solve this is to have a boolean value to guard the <code>println!</code> and prevent further calls while the flag is still set. We&rsquo;ll set the flag the first time we enter  <code>alloc</code>, and then on subsequent calls we&rsquo;ll check that flag, and if it is set, we won&rsquo;t bother trying to call <code>println!</code> again. Once we have done our work, we&rsquo;ll unset that flag, allowing future calls to <code>println!</code> again.</p>
<p>So after all that, our <code>alloc</code> function should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(<span style="color:#f92672">&amp;</span>self, layout: <span style="color:#a6e22e">Layout</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> self.<span style="color:#ae81ff">0.</span>alloc(layout);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>GUARD {
</span></span><span style="display:flex;"><span>		GUARD <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		println!(<span style="color:#e6db74">&#34;{} bytes&#34;</span>, layout.size());
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		GUARD <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	ptr
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If we run our application and check the output now we should get something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">5</span> bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">48</span> bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">15</span> bytes
</span></span><span style="display:flex;"><span>Hello, Clarice!
</span></span></code></pre></div><p>Success! We can now see some allocations are being made and our program completes successfully.</p>
<p>Interestingly though there are a few more allocations than the one we would expect from our simple application. The last one for 15 bytes makes sense though. We need exactly 15 bytes to hold our <code>&quot;Hello, Clarice!&quot;</code> string, but what are the other allocations for?</p>
<p>For that we&rsquo;re unfortunately going to need a bit of extra information, which leads us to&hellip;</p>
<h2 id="backtracing-the-ip">Backtracing the IP</h2>
<p>What we really need is some information about where in our application we are when an allocation is requested. For that I recommend we use a crate called <code>backtrace</code>. This will allow us to get some runtime information about the stack frame we&rsquo;re in, which will in turn also allow us to filter out some of the data we&rsquo;re not interested in.</p>
<p>As I mentioned earlier, blindly pulling a crate into your project is not something that I would normally advocate for. However, this is an experiment, and understanding how backtraces are captured is somewhat out of scope for us at the moment. I do suggest taking a look at the source for <a href="https://github.com/rust-lang/backtrace-rs">backtrace</a> when you get the chance though.</p>
<p>Also, I won&rsquo;t go into too much detail about what backtraces are in this article either. For our purposes, all you need to know is that a backtrace allows us to step back through time to see where we were in our code, when an allocation was requested. We&rsquo;ll get helpful information like the name of the file, function and even the line number where this occurred, assuming we are running our application in debug mode of course. Debug mode will leave all that information in the final binary, whereas release mode will strip it out for performance reasons. There are ways to add this back in for release mode, but I&rsquo;ll leave that up to you to figure out.</p>
<p>With all that said, lets add the following to our <code>cargo.toml</code> file to get the <code>backtrace</code> crate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-toml" data-lang="toml"><span style="display:flex;"><span>[<span style="color:#a6e22e">dependencies</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">backtrace</span> = <span style="color:#e6db74">&#34;0.3.66&#34;</span>
</span></span></code></pre></div><p>Then in the guarded section of our <code>alloc</code>  function we&rsquo;re going to capture a <code>backtrace</code>, step through all the stack frames, and pull out the information we&rsquo;re looking for.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Don&#39;t forget to import Backtrace
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">use</span> backtrace::Backtrace;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// A global value we can use if we don&#39;t find the values we&#39;re looking for
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> UNKNOWN: <span style="color:#66d9ef">&amp;</span><span style="color:#66d9ef">str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;unknown&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsafe</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">alloc</span>(<span style="color:#f92672">&amp;</span>self, layout: <span style="color:#a6e22e">Layout</span>) -&gt; <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u8</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> ptr <span style="color:#f92672">=</span> self.<span style="color:#ae81ff">0.</span>alloc(layout);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>GUARD {
</span></span><span style="display:flex;"><span>		GUARD <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">let</span> bt <span style="color:#f92672">=</span> Backtrace::new();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">for</span> frame <span style="color:#66d9ef">in</span> bt.frames() {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> symbol <span style="color:#66d9ef">in</span> frame.symbols() {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Here we are pulling out the name of the function, in which file 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// the function can be found, and the line number where the 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#75715e">// allocation occurs.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#66d9ef">let</span> name <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>					.name()
</span></span><span style="display:flex;"><span>					.map(<span style="color:#f92672">|</span>n<span style="color:#f92672">|</span> n.to_string())
</span></span><span style="display:flex;"><span>					.unwrap_or(UNKNOWN.to_string());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">let</span> filename <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>					.filename()
</span></span><span style="display:flex;"><span>					.map(<span style="color:#f92672">|</span>f<span style="color:#f92672">|</span> f.display().to_string())
</span></span><span style="display:flex;"><span>					.unwrap_or(UNKNOWN.to_string());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">let</span> lineno <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>					.lineno()
</span></span><span style="display:flex;"><span>					.map(<span style="color:#f92672">|</span>l<span style="color:#f92672">|</span> l.to_string())
</span></span><span style="display:flex;"><span>					.unwrap_or(UNKNOWN.to_string());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>				println!(<span style="color:#e6db74">&#34;{}:{} {} {} bytes&#34;</span>, 
</span></span><span style="display:flex;"><span>					name, 
</span></span><span style="display:flex;"><span>					lineno, 
</span></span><span style="display:flex;"><span>					filename, 
</span></span><span style="display:flex;"><span>					layout.size());
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		GUARD <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ptr
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Besides the nuances of <code>backtrace</code> itself, I think the code here should be fairly self-explanatory for those with some familiarity with Rust. There are some definite inefficiencies with our implementation above, but it&rsquo;ll do for our purposes for now.</p>
<p>Running this now and we should start to see the bigger picture:</p>
<pre tabindex="0"><code class="language-rust_errors" data-lang="rust_errors">&#34;backtrace::backtrace::dbghelp::trace&#34;:98 &#34;.cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.66\\src\\backtrace\\dbghelp.rs&#34; 5 bytes
&#34;backtrace::backtrace::trace_unsynchronized&lt;backtrace::capture::impl$1::create::closure_env$0&gt;&#34;:66 &#34; .cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.66\\src\\backtrace\\mod.rs&#34; 5 bytes
&#34;backtrace::backtrace::trace&lt;backtrace::capture::impl$1::create::closure_env$0&gt;&#34;:53 &#34; .cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.66\\src\\backtrace\\mod.rs&#34; 5 bytes
&#34;backtrace::capture::Backtrace::create&#34;:176 &#34; .cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.66\\src\\capture.rs&#34; 5 bytes
&#34;backtrace::capture::Backtrace::new&#34;:140 &#34; .cargo\\registry\\src\\github.com-1ecc6299db9ec823\\backtrace-0.3.66\\src\\capture.rs&#34; 5 bytes
&#34;alloc::impl$0::alloc&lt;std::alloc::System&gt;&#34;:20 &#34;rust-bits-and-pieces\\src\\alloc.rs&#34; 5 bytes
&#34;alloc::_::__rg_alloc&#34;:140 &#34;rust-bits-and-pieces\\src\\alloc.rs&#34; 5 bytes
</code></pre><p>And that bigger picture is a bit of a mess.</p>
<p>What we have here is the full path that our code traverses at the point a backtrace is captured. Including the inner functions of backtrace itself, the Rust standard library and even kernel/OS level calls. It is kind of hard to make out the bit we&rsquo;re interested in, so in order to facilitate this we&rsquo;re going to need to cut back a lot of the cruft.</p>
<p>Here are a couple of conditionals we can add to the code block to remove all the things we&rsquo;re not interested in:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#75715e">// Add this as a global outside of the alloc function
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> IGNORED_WORDS: [<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">str</span>; <span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;invoke_main&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;__scrt_common_main_seh&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;alloc::_::__rg_alloc&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;backtrace::&#34;</span>,
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">..</span>. 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Back inside our alloc function again, we add in the conditionals
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> filename <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>	.filename()
</span></span><span style="display:flex;"><span>	.map(<span style="color:#f92672">|</span>f<span style="color:#f92672">|</span> f.display().to_string())
</span></span><span style="display:flex;"><span>	.unwrap_or(UNKNOWN.to_string());
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span><span style="color:#75715e">// This strips out most of the rust std library code and anything without a filename 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> filename.starts_with(<span style="color:#e6db74">&#34;/rustc&#34;</span>) <span style="color:#f92672">||</span> filename.eq(UNKNOWN) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> name <span style="color:#f92672">=</span> symbol
</span></span><span style="display:flex;"><span>	.name()
</span></span><span style="display:flex;"><span>	.map(<span style="color:#f92672">|</span>n<span style="color:#f92672">|</span> n.to_string())
</span></span><span style="display:flex;"><span>	.unwrap_or(UNKNOWN.to_string());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// And this strips out all the rest of the things we don&#39;t care about
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> IGNORED_WORDS
</span></span><span style="display:flex;"><span>	.iter()
</span></span><span style="display:flex;"><span>	.any(<span style="color:#f92672">|</span>n<span style="color:#f92672">|</span> name.starts_with(n) <span style="color:#f92672">||</span> name.ends_with(n)) 
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">||</span> name.contains(<span style="color:#e6db74">&#34;std::alloc::System&#34;</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">..</span>.
</span></span></code></pre></div><p>Running this should now give something far more relevant:</p>
<pre tabindex="0"><code class="language-rust_errors" data-lang="rust_errors">&#34;alloc::main&#34;:162 &#34;rust-bits-and-pieces\\src\\alloc.rs&#34; 15 bytes
Hello, world!
</code></pre><p>Success! We can now see the exact spot where we allocated our string in <code>main</code> and how many bytes were allocated.</p>
<h2 id="bonus-objective-threading">Bonus objective: Threading</h2>
<p>There is one major problem with our solution. It isn&rsquo;t thread safe. More specifically the guard we&rsquo;re using isn&rsquo;t thread safe. We could potentially end up in a situation where multiple threads are trying to allocate memory at the same time, and one of those threads could be blocked by the guard being set, causing us to miss reporting the allocation.</p>
<p>A quick way to resolve this is to have a guard for each thread, which can be achieved quite simply with <a href="https://doc.rust-lang.org/std/thread/struct.LocalKey.html">thread_local storage</a>. I won&rsquo;t explain the intricacies of thread local storage here, but suffice it to say that it should achieve our stated goal of a single instance of <code>GUARD</code> per thread. Once again, I suggest you read up a little about it after this exercise is done.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>thread_local! {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">mut</span> GUARD: <span style="color:#66d9ef">bool</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Unfortunately for us, this doesn&rsquo;t compile. <code>thread_local</code> does not support mutable values, so we&rsquo;ll need to reach for a <a href="https://doc.rust-lang.org/std/cell/index.html">Cell</a>.</p>
<p>This article is pretty long already, so I won&rsquo;t go into too much detail with regards to how <code>Cell</code> works, but importantly it allows us to mutate a value without it being marked as <code>mut</code>. It does this by creating a copy of the value in the <code>Cell</code> when you <code>get</code> it, and replacing the value inside when you <code>set</code> it, rather than sharing the underlying value around. The linked documentation on <code>Cell</code> is pretty good, and you should definitely give it a read if you are going to be doing Rust in any serious capacity.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span>GUARD.with(<span style="color:#f92672">|</span>guard<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>guard.get() {
</span></span><span style="display:flex;"><span>		guard.set(<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// Guarded code goes in here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		guard.set(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>With that change in we, things should work the same as they did before, except that you&rsquo;ll get slightly less buggy behaviour in a threaded environment.</p>
<p>Once again there are likely better and more efficient ways to solve this problem. Writing to STDOUT during a performance critical section of your code is definitely going to suffer using this allocator, but as a simple learning exercise this will do fine. However, if want to identify some simple places where allocations are taking place in your code, this should do the job.</p>
<p>Congratulations, you did it!</p>
<p><em>Once again, <a href="https://gist.github.com/shiver/87ccd945ea62626ed40531b974988da6">here</a> is the final implementation for you to review.</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>If you take a look at the final implementation there really isn&rsquo;t that much code here. Yes it isn&rsquo;t very efficient, and sure it doesn&rsquo;t cover every scenario, but if your goal is to actually learn and take on this information, this exercise will hopefully have helped in that regard.</p>
<p>For mission critical projects you can certainly find a more complete solution, but if you&rsquo;re just working on a hobby project, or experimenting, making your own will give a healthy dose of perspective, and perhaps a greater appreciation for how simple or hard things actually are.</p>
<hr>
<h2 id="references">References</h2>
<ul>
<li>The <a href="https://docs.rs/backtrace/0.3.66/backtrace/">documentation</a> and <a href="https://github.com/rust-lang/backtrace-rs">source</a> for the backtrace crate</li>
<li>Rust documentation for <a href="https://doc.rust-lang.org/std/alloc/index.html">std::alloc</a></li>
<li>Rust documentation for <a href="https://doc.rust-lang.org/std/alloc/struct.Layout.html">Layout</a></li>
<li>Rust documentation for <a href="https://doc.rust-lang.org/std/cell/index.html">Cell</a></li>
<li>Rust documentation for <a href="https://doc.rust-lang.org/std/thread/struct.LocalKey.html">thread_local storage</a></li>
<li><a href="https://www.jamesgolick.com/2013/5/15/memory-allocators-101.html">Article</a> by James Golick on how memory allocators work under the hood</li>
<li>Rust&rsquo;s <a href="https://rustc-dev-guide.rust-lang.org/borrow_check.html">secret sauce</a></li>
</ul>

    </div>
    
    <div class="nav-center">
    <a class="nav-item" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fshiver.github.io%2fpost%2ftracking-heap-allocations-in-rust%2f" title="Share on Facebook" target="_blank"><span class="fa fa-facebook fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fshiver.github.io%2fpost%2ftracking-heap-allocations-in-rust%2f" title="Share on LinkedIn" target="_blank"><span class="fa fa-linkedin fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="https://twitter.com/home?status=Make%20your%20own%20quick%2c%20%22simple%22%20and%20portable%20heap%20allocation%20tracker%20in%20Rust - https%3a%2f%2fshiver.github.io%2fpost%2ftracking-heap-allocations-in-rust%2f" title="Tweet this" target="_blank"><span class="fa fa-twitter fa-2x"></span></a>
    <a class="nav-item" href="http://www.reddit.com/submit?url=https%3a%2f%2fshiver.github.io%2fpost%2ftracking-heap-allocations-in-rust%2f&title=Make%20your%20own%20quick%2c%20%22simple%22%20and%20portable%20heap%20allocation%20tracker%20in%20Rust" title="Share on Reddit" target="_blank"><span class="fa fa-reddit-alien fa-2x" aria-hidden="true"></span></a>
    <a class="nav-item" href="mailto:?subject=Make%20your%20own%20quick%2c%20%22simple%22%20and%20portable%20heap%20allocation%20tracker%20in%20Rust&body=%3ch2%20id%3d%22introduction%22%3eIntroduction%3c%2fh2%3e%0a%3cp%3eBesides%20altering%20your%20algorithms%2c%20another%20easy%20way%20to%20improve%20the%20performance%20of%20your%20code%20is%20by%20reducing%20heap%20allocations.%20Compared%20to%20the%20heap%2c%20stack%20allocations%20are%20significantly%20faster%20to%20both%20allocate%20and%20free%2c%20as%20they%20are%20usually%20done%20by%20simply%20updating%20a%20pointer%2c%20potentially%20in%20a%20single%20operation%2c%20and%20often%20by%20a%20dedicated%20CPU%20register.%3c%2fp%3e%0a%3cp%3eThe%20heap%20on%20the%20other%20hand%20is%20a%20%3ca%20href%3d%22https%3a%2f%2fwww.jamesgolick.com%2f2013%2f5%2f15%2fmemory-allocators-101.html%22%3ecomplicated%3c%2fa%3e%20beast.%20There%20is%20a%20fair%20amount%20of%20bookkeeping%20involved%20when%20acquiring%20and%20potentially%20releasing%20memory%20for%20your%20application%2c%20and%20avoiding%20this%20overhead%20will%20usually%20net%20you%20some%20decent%20performance%20gains%2c%20especially%20if%20these%20are%20happening%20frequently%20in%20your%20code.%3c%2fp%3e%0a%3cp%3eImportantly%20Rust%20is%20a%20systems%20programming%20language%2c%20albeit%20with%20a%20slight%20%3ca%20href%3d%22https%3a%2f%2frustc-dev-guide.rust-lang.org%2fborrow_check.html%22%3etwist%3c%2fa%3e.%20One%20of%20the%20important%20aspects%20of%20systems%20programming%20languages%20is%20that%20you%20usually%20have%20to%20pay%20a%20little%20more%20attention%20to%20memory%20than%20you%20otherwise%20would%20in%20a%20language%20where%20memory%20is%20managed%20for%20you.%20Given%20the%20%26ldquo%3bmodern%26rdquo%3b%20feel%20that%20Rust%20has%2c%20it%20can%20sometimes%20be%20surprising%20how%20and%20where%20memory%20is%20being%20used%2c%20especially%20for%20those%20new%20to%20these%20types%20of%20languages%2c%20or%20perhaps%20just%20uninitiated%20with%20the%20idiosyncrasies%20of%20Rust%20itself.%3c%2fp%3e%0a%3cp%3eTo%20hopefully%20demystify%20this%20subject%20a%20little%2c%20we%26rsquo%3bre%20going%20to%20delve%20into%20Rust%26rsquo%3bs%20memory%20allocators%2c%20replace%20the%20default%20global%20allocator%2c%20whilst%20adding%20a%20bit%20of%20instrumentation%20to%20surface%20where%20and%20when%20allocations%20are%20issued.%3c%2fp%3e%0a%3cp%3eObviously%20this%20will%20not%20be%20a%20full%20robust%20solution%20we%26rsquo%3bre%20developing%20here%2c%20but%20more%20of%20an%20introduction%20into%20the%20topic%2c%20and%20one%20that%20you%20can%20choose%20to%20venture%20further%20with%20if%20you%20so%20wish.%3c%2fp%3e%0a%3cp%3eIt%20should%20go%20without%20saying%20there%20are%20likely%20%28definitely%29%20better%20options%20out%20there.%20Ones%20that%20are%20more%20robust%2c%20with%20fewer%20bugs%20and%20fully%20featured%2c%20but%20writing%20our%20own%20gives%20us%20some%20exposure%20to%20the%20inner%20workings%20of%20the%20Rust%20standard%20library%2c%20and%20also%20an%20understanding%20as%20to%20why%20the%20alternatives%20might%20be%20better%20or%20worse%20than%20our%20simple%20solution.%3c%2fp%3e%0a%3cp%3eBlindly%20reaching%20for%20a%20dependency%20when%20you%20don%26rsquo%3bt%20fully%20understand%20the%20problem%20you%26rsquo%3bre%20solving%2c%20let%20alone%20the%20solution%2c%20is%20not%20a%20good%20habit%20in%20my%20opinion.%20%20Understanding%20the%20benefits%20and%20drawbacks%20of%20your%20dependency%20choices%20is%20an%20often%20overlooked%20skill%20that%20you%20should%20always%20seek%20to%20exercise%20as%20a%20software%20developer.%20And%20how%20can%20you%20possibly%20do%20that%20if%20you%20never%20look%20behind%20the%20curtain%3f%3c%2fp%3e%0a%3cp%3eFor%20those%20who%20don%26rsquo%3bt%20want%20to%20go%20through%20the%20exercise%2c%20or%20who%20just%20want%20to%20see%20the%20code%20in%20its%20final%20form%20before%20going%20through%20the%20steps%20below%2c%20you%20can%20take%20a%20look%20at%20this%20%3ca%20href%3d%22https%3a%2f%2fgist.github.com%2fshiver%2f87ccd945ea62626ed40531b974988da6%22%3egist%3c%2fa%3e.%3c%2fp%3e%0a%3cp%3eOnwards%26hellip%3b%3c%2fp%3e%0a%3ch2%20id%3d%22how-to-replace-the-global-allocator%22%3eHow%20to%20replace%20the%20global%20allocator%3c%2fh2%3e%0a%3cp%3eFirstly%2c%20the%20global%20allocator%20can%20be%20replaced%20by%20simply%20adding%20the%20%3ccode%3e%23%5bglobal_allocator%5d%3c%2fcode%3e%20annotation%20to%20your%20allocator%20of%20choice%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3euse%3c%2fspan%3e%20std%3a%3aalloc%3a%3a%7bSystem%7d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%23%5bglobal_allocator%5d%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3estatic%3c%2fspan%3e%20GLOBAL_ALLOCATOR%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eSystem%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20System%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eThis%20bit%20of%20code%20is%20clearly%20redundant%20as%20we%20are%20simply%20setting%20the%20global%20allocator%20back%20to%20the%20default%20%3ccode%3eSystem%3c%2fcode%3e%20allocator.%20This%20usually%20happens%20regardless%2c%20but%20now%20you%20know%20how%20it%20is%20done.%3c%2fp%3e%0a%3ch2%20id%3d%22making-our-very-own-allocator%22%3eMaking%20our%20very%20own%20allocator%3c%2fh2%3e%0a%3cp%3eFirst%20off%20we%20need%20to%20make%20our%20own%20allocator%20type.%20We%26rsquo%3bll%20call%20it%20%3ccode%3eInstrumentedAllocator%3c%2fcode%3e%21%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3epub%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3estruct%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eInstrumentedAllocator%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eT%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%28T%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eYou%26rsquo%3bve%20probably%20noticed%20that%20our%20allocator%20is%20a%20generic%20type%2c%20with%20a%20single%20field%20holding%20that%20generic%20type.%20We%20will%20cover%20the%20reason%20for%20this%20in%20a%20little%20bit.%3c%2fp%3e%0a%3cp%3eUp%20next%20we%20need%20to%20implement%20%3ccode%3eGlobalAlloc%3c%2fcode%3e%20for%20our%20struct.%20This%20is%20a%20mandatory%20trait%20that%20all%20global%20allocators%20must%20implement%20for%20us%20to%20be%20able%20to%20successfully%20annotate%20our%20allocator%20with%20%3ccode%3e%23%5bglobal_allocator%5d%3c%2fcode%3e.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eimpl%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eT%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%20GlobalAlloc%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efor%3c%2fspan%3e%20InstrumentedAllocator%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eT%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3ewhere%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20T%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eGlobalAlloc%3c%2fspan%3e%2c%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3ealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20-%26gt%3b%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%20%7b%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3edealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20ptr%3a%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20%7b%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eThere%20are%20just%20a%20couple%20of%20mandatory%20functions%20%28%3ccode%3ealloc%3c%2fcode%3e%20and%20%3ccode%3edealloc%3c%2fcode%3e%29%20which%20the%20%3ccode%3eGlobalAlloc%3c%2fcode%3e%20trait%20requires%20we%20implement.%20I%20think%20their%20purposes%20are%20fairly%20self-explanatory.%20One%20acquires%20the%20memory%2c%20the%20other%20releases%20it.%3c%2fp%3e%0a%3cp%3eTo%20answer%20the%20question%20from%20before%2c%20%26ldquo%3bwhy%20is%20our%20allocator%20a%20generic%20type%26rdquo%3b%2c%20%20we%20can%20see%20now%20that%20we%20want%20to%20to%20store%20something%20that%20implements%20%3ccode%3eGlobalAlloc%3c%2fcode%3e%20in%20our%20type.%20Why%20would%20we%20need%20to%20store%20%3cem%3eanother%3c%2fem%3e%20%3ccode%3eGlobalAlloc%3c%2fcode%3e%20in%20our%20allocator%20that%20is%20already%20implementing%20%3ccode%3eGlobalAlloc%3c%2fcode%3e%3f%3c%2fp%3e%0a%3cp%3eThe%20answer%20is%20that%20we%20need%20some%20way%20to%20actually%20allocate%20memory.%20We%20%3cem%3ecould%3c%2fem%3e%20write%20all%20the%20allocation%20code%20ourselves%2c%20but%20the%20purpose%20of%20this%20exercise%20is%20only%20to%20instrument%20allocations.%20So%20to%20keep%20this%20simple%20we%20will%20use%20the%20system%20allocator%20to%20do%20the%20heavy%20lifting%20for%20us%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%23%5bglobal_allocator%5d%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3estatic%3c%2fspan%3e%20ALLOCATOR%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eInstrumentedAllocator%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eSystem%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20InstrumentedAllocator%28System%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eIt%20is%20worth%20noting%20that%20by%20using%20the%20system%20allocator%20we%20are%20avoiding%20portability%20issues.%20Out%20of%20the%20box%20the%20system%20allocator%20supports%20all%20the%20different%20platforms%20that%20Rust%20runs%20on.%20If%20we%20wrote%20our%20own%20memory%20allocator%20we%20would%20need%20to%20take%20those%20different%20platforms%20into%20consideration%21%20Definitely%20out%20of%20scope%20for%20now.%3c%2fp%3e%0a%3ch2%20id%3d%22implementing-alloc%22%3eImplementing%20%3ccode%3ealloc%3c%2fcode%3e%3c%2fh2%3e%0a%3cp%3eOur%20code%20obviously%20won%26rsquo%3bt%20compile%20yet%3a%3c%2fp%3e%0a%3cpre%20tabindex%3d%220%22%3e%3ccode%20class%3d%22language-rust_errors%22%20data-lang%3d%22rust_errors%22%3e%20%20%20%7c%0d%0a12%20%7c%20%20%20%20%20unsafe%20fn%20alloc%28%26amp%3bself%2c%20layout%3a%20Layout%29%20-%26gt%3b%20%2amut%20u8%20%7b%0d%0a%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20-----%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5e%5e%5e%5e%5e%5e%5e%20expected%20%2a-ptr%2c%20found%20%60%28%29%60%0d%0a%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7c%0d%0a%20%20%20%7c%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20implicitly%20returns%20%60%28%29%60%20as%20its%20body%20has%20no%20tail%20or%20%60return%60%20expression%0d%0a%20%20%20%7c%0d%0a%20%20%20%3d%20note%3a%20expected%20raw%20pointer%20%60%2amut%20u8%60%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20found%20unit%20type%20%60%28%29%60%0a%3c%2fcode%3e%3c%2fpre%3e%3cp%3eWe%20first%20need%20to%20provide%20implementations%20for%20our%20trait%20functions.%20%20We%26rsquo%3bll%20start%20with%20%3ccode%3ealloc%3c%2fcode%3e.%3c%2fp%3e%0a%3cp%3eThis%20function%20takes%20just%20one%20parameter%20which%20is%20the%20desired%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2falloc%2fstruct.Layout.html%22%3elayout%3c%2fa%3e%20of%20the%20memory%20being%20requested%2c%20and%20in%20response%20will%20return%20a%20mutable%20pointer%20to%20the%20start%20of%20our%20block%20of%20bytes.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3ealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20-%26gt%3b%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20ptr%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20self.%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0.%3c%2fspan%3ealloc%28layout%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09ptr%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eAbout%20the%20only%20thing%20in%20here%20that%20might%20need%20a%20bit%20of%20an%20explanation%20is%20the%20use%20of%20%3ccode%3eself.0.alloc%3c%2fcode%3e.%20Since%20our%20struct%20definition%20uses%20an%20unnamed%20field%2c%20we%20need%20to%20refer%20to%20it%20by%20its%20%3cem%3eposition%3c%2fem%3e%2c%20rather%20than%20by%20its%20%3cem%3ename%3c%2fem%3e.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3epub%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3estruct%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eInstrumentedAllocator%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eT%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%28T%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20%20self.0%20refers%20to%20this%20field%20----%5e%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20The%20code%20below%20is%20equivaltent%20to%20the%20line%20above.%20%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20The%20code%20below%20won%26%2339%3bt%20compile%20though%2c%20since%20it%20is%20against%20the%20rules%20to%20use%20%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20pure%20numbers%20for%20field%20names.%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3epub%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3estruct%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eInstrumentedAllocator%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eT%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3epub%3c%2fspan%3e%20T%20%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eSo%20what%20%3ccode%3eself.0.alloc%28layout%29%3c%2fcode%3e%20is%20saying%20is%20simply%20that%20we%20are%20calling%20%3ccode%3ealloc%28%29%3c%2fcode%3e%20on%20the%20type%20that%20is%20set%20to%20that%20first%20field%20in%20our%20struct%2c%20which%20just%20so%20happens%20to%20be%20a%20generic%20type.%20In%20our%20case%20this%20generic%20type%20is%20the%20system%20allocator%2c%20since%20that%20is%20what%20we%20passed%20in%20earlier%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3estatic%3c%2fspan%3e%20ALLOCATOR%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eInstrumentedAllocator%3c%2fspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e%26lt%3b%3c%2fspan%3eSystem%3cspan%20style%3d%22color%3a%23f92672%22%3e%26gt%3b%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20InstrumentedAllocator%28System%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eHopefully%20that%20clears%20everything%20up.%20Regardless%2c%20onto%20%3ccode%3edealloc%3c%2fcode%3e%26hellip%3b%3c%2fp%3e%0a%3ch2%20id%3d%22implementing-dealloc%22%3eImplementing%20%3ccode%3edealloc%3c%2fcode%3e%3c%2fh2%3e%0a%3cp%3eMuch%20like%20%3ccode%3ealloc%3c%2fcode%3e%2c%20%3ccode%3edealloc%3c%2fcode%3e%20is%20very%20simple%20for%20us%20to%20implement%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3edealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20ptr%3a%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09self.%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0.%3c%2fspan%3edealloc%28ptr%2c%20layout%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eThere%20isn%26rsquo%3bt%20much%20to%20explain%20here%2c%20other%20than%20we%20are%20expecting%20to%20pass%20in%20the%20same%20raw%20pointer%20we%20received%20from%20our%20call%20to%20%3ccode%3ealloc%3c%2fcode%3e%20along%20with%20the%20%3ccode%3eLayout%3c%2fcode%3e.%20Once%20again%20we%20are%20calling%20the%20system%20%3ccode%3edealloc%3c%2fcode%3e%20function%2c%20and%20then%20calling%20it%20a%20day.%3c%2fp%3e%0a%3cp%3eAnd%20with%20that%2c%20we%20now%20should%20have%20a%20working%20allocator.%20If%20we%20stick%20something%20simple%20in%20%3ccode%3emain%3c%2fcode%3e%20we%20can%20confirm%20that%20things%20are%20working.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3emain%3c%2fspan%3e%28%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Try%20something%20that%20we%20know%20will%20allocate%20on%20the%20heap%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20s%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20String%3a%3afrom%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bHello%2c%20Clarice%21%26%2334%3b%3c%2fspan%3e%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09println%21%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%7b%7d%26%2334%3b%3c%2fspan%3e%2c%20s%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eSuccess%21%3c%2fp%3e%0a%3cpre%20tabindex%3d%220%22%3e%3ccode%20class%3d%22language-rust_errors%22%20data-lang%3d%22rust_errors%22%3eFinished%20dev%20%5bunoptimized%20%2b%20debuginfo%5d%20target%28s%29%20in%201.64s%0d%0a%20%20%20%20%20Running%20%60target%2fdebug%2fplayground%60%0d%0aHello%2c%20Clarice%21%0a%3c%2fcode%3e%3c%2fpre%3e%3cp%3eObviously%20there%20is%20nothing%20new%20happening%20yet%2c%20but%20this%20just%20proves%20that%20our%20new%20allocator%20is%20working%20as%20it%20should.%3c%2fp%3e%0a%3cp%3eOn%20to%20the%20interesting%20stuff%26hellip%3b%3c%2fp%3e%0a%3ch2%20id%3d%22instrumentation%22%3eInstrumentation%3c%2fh2%3e%0a%3cp%3eOk%2c%20with%20the%20ground%20work%20done%20%28the%20allocation%29%2c%20we%20can%20now%20start%20to%20work%20on%20instrumenting%20that%20allocation%20with%20a%20bit%20of%20information.%20Lets%20just%20add%20a%20simple%20print%20to%20STDOUT%20with%20the%20number%20of%20bytes%20we%26rsquo%3bve%20allocated.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3ealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20-%26gt%3b%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20ptr%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20self.%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0.%3c%2fspan%3ealloc%28layout%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09println%21%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%7b%7d%20bytes%26%2334%3b%3c%2fspan%3e%2c%20layout.size%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09ptr%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cpre%20tabindex%3d%220%22%3e%3ccode%20class%3d%22language-rust_errors%22%20data-lang%3d%22rust_errors%22%3eerror%3a%20process%20didn%26%2339%3bt%20exit%20successfully%3a%20%60target%5cdebug%5calloc.exe%60%20%28exit%20code%3a%200xc0000005%2c%20STATUS_ACCESS_VIOLATION%29%0a%3c%2fcode%3e%3c%2fpre%3e%3cp%3eUh%2c%20what%3f%20How%20does%20a%20%3ccode%3eprintln%21%3c%2fcode%3e%20cause%20a%20panic%3f%3c%2fp%3e%0a%3cp%3eIt%20is%20actually%20fairly%20simple%20if%20you%20think%20about%20it.%20While%20allocating%20the%20memory%20we%20are%20trying%20to%20call%20%3ccode%3eprintln%21%3c%2fcode%3e.%20Given%20that%20the%20string%20we%26rsquo%3bre%20trying%20to%20display%20is%20constructed%20at%20runtime%2c%20we%20first%20need%20to%20allocate%20some%20memory%20for%20that%20string%20before%20we%20can%20write%20to%20it.%20Of%20course%2c%20this%20will%20need%20to%20call%20the%20global%20allocator%20to%20request%20that%20extra%20bit%20of%20memory.%20Wait.%20We%26rsquo%3bre%20the%20global%20allocator%21%20So%20we%20call%20our%20own%20%3ccode%3ealloc%3c%2fcode%3e%20function%20%3cem%3eagain%3c%2fem%3e%2c%20which%20then%20calls%20%3ccode%3eprintln%21%3c%2fcode%3e%20%3cem%3eagain%3c%2fem%3e%2c%20which%20then%20needs%20to%20call%20%3ccode%3ealloc%3c%2fcode%3e%20%3cem%3eagain%3c%2fem%3e%26hellip%3b%20I%20think%20you%20get%20the%20picture.%3c%2fp%3e%0a%3cp%3eWhat%20we%20have%20here%20is%20an%20infinite%20loop%20of%20allocations%20which%20we%20need%20to%20somehow%20break%20if%20we%20are%20going%20to%20be%20able%20to%20call%20%3ccode%3eprintln%21%3c%2fcode%3e%20from%20within%20our%20allocator.%3c%2fp%3e%0a%3cp%3eThe%20simplest%20way%20to%20solve%20this%20is%20to%20have%20a%20boolean%20value%20to%20guard%20the%20%3ccode%3eprintln%21%3c%2fcode%3e%20and%20prevent%20further%20calls%20while%20the%20flag%20is%20still%20set.%20We%26rsquo%3bll%20set%20the%20flag%20the%20first%20time%20we%20enter%20%20%3ccode%3ealloc%3c%2fcode%3e%2c%20and%20then%20on%20subsequent%20calls%20we%26rsquo%3bll%20check%20that%20flag%2c%20and%20if%20it%20is%20set%2c%20we%20won%26rsquo%3bt%20bother%20trying%20to%20call%20%3ccode%3eprintln%21%3c%2fcode%3e%20again.%20Once%20we%20have%20done%20our%20work%2c%20we%26rsquo%3bll%20unset%20that%20flag%2c%20allowing%20future%20calls%20to%20%3ccode%3eprintln%21%3c%2fcode%3e%20again.%3c%2fp%3e%0a%3cp%3eSo%20after%20all%20that%2c%20our%20%3ccode%3ealloc%3c%2fcode%3e%20function%20should%20look%20like%20this%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3ealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20-%26gt%3b%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20ptr%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20self.%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0.%3c%2fspan%3ealloc%28layout%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%21%3c%2fspan%3eGUARD%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09GUARD%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3etrue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09println%21%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%7b%7d%20bytes%26%2334%3b%3c%2fspan%3e%2c%20layout.size%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09GUARD%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09ptr%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eIf%20we%20run%20our%20application%20and%20check%20the%20output%20now%20we%20should%20get%20something%20like%20this%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-shell%22%20data-lang%3d%22shell%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23ae81ff%22%3e5%3c%2fspan%3e%20bytes%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23ae81ff%22%3e48%3c%2fspan%3e%20bytes%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23ae81ff%22%3e64%3c%2fspan%3e%20bytes%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23ae81ff%22%3e15%3c%2fspan%3e%20bytes%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eHello%2c%20Clarice%21%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eSuccess%21%20We%20can%20now%20see%20some%20allocations%20are%20being%20made%20and%20our%20program%20completes%20successfully.%3c%2fp%3e%0a%3cp%3eInterestingly%20though%20there%20are%20a%20few%20more%20allocations%20than%20the%20one%20we%20would%20expect%20from%20our%20simple%20application.%20The%20last%20one%20for%2015%20bytes%20makes%20sense%20though.%20We%20need%20exactly%2015%20bytes%20to%20hold%20our%20%3ccode%3e%26quot%3bHello%2c%20Clarice%21%26quot%3b%3c%2fcode%3e%20string%2c%20but%20what%20are%20the%20other%20allocations%20for%3f%3c%2fp%3e%0a%3cp%3eFor%20that%20we%26rsquo%3bre%20unfortunately%20going%20to%20need%20a%20bit%20of%20extra%20information%2c%20which%20leads%20us%20to%26hellip%3b%3c%2fp%3e%0a%3ch2%20id%3d%22backtracing-the-ip%22%3eBacktracing%20the%20IP%3c%2fh2%3e%0a%3cp%3eWhat%20we%20really%20need%20is%20some%20information%20about%20where%20in%20our%20application%20we%20are%20when%20an%20allocation%20is%20requested.%20For%20that%20I%20recommend%20we%20use%20a%20crate%20called%20%3ccode%3ebacktrace%3c%2fcode%3e.%20This%20will%20allow%20us%20to%20get%20some%20runtime%20information%20about%20the%20stack%20frame%20we%26rsquo%3bre%20in%2c%20which%20will%20in%20turn%20also%20allow%20us%20to%20filter%20out%20some%20of%20the%20data%20we%26rsquo%3bre%20not%20interested%20in.%3c%2fp%3e%0a%3cp%3eAs%20I%20mentioned%20earlier%2c%20blindly%20pulling%20a%20crate%20into%20your%20project%20is%20not%20something%20that%20I%20would%20normally%20advocate%20for.%20However%2c%20this%20is%20an%20experiment%2c%20and%20understanding%20how%20backtraces%20are%20captured%20is%20somewhat%20out%20of%20scope%20for%20us%20at%20the%20moment.%20I%20do%20suggest%20taking%20a%20look%20at%20the%20source%20for%20%3ca%20href%3d%22https%3a%2f%2fgithub.com%2frust-lang%2fbacktrace-rs%22%3ebacktrace%3c%2fa%3e%20when%20you%20get%20the%20chance%20though.%3c%2fp%3e%0a%3cp%3eAlso%2c%20I%20won%26rsquo%3bt%20go%20into%20too%20much%20detail%20about%20what%20backtraces%20are%20in%20this%20article%20either.%20For%20our%20purposes%2c%20all%20you%20need%20to%20know%20is%20that%20a%20backtrace%20allows%20us%20to%20step%20back%20through%20time%20to%20see%20where%20we%20were%20in%20our%20code%2c%20when%20an%20allocation%20was%20requested.%20We%26rsquo%3bll%20get%20helpful%20information%20like%20the%20name%20of%20the%20file%2c%20function%20and%20even%20the%20line%20number%20where%20this%20occurred%2c%20assuming%20we%20are%20running%20our%20application%20in%20debug%20mode%20of%20course.%20Debug%20mode%20will%20leave%20all%20that%20information%20in%20the%20final%20binary%2c%20whereas%20release%20mode%20will%20strip%20it%20out%20for%20performance%20reasons.%20There%20are%20ways%20to%20add%20this%20back%20in%20for%20release%20mode%2c%20but%20I%26rsquo%3bll%20leave%20that%20up%20to%20you%20to%20figure%20out.%3c%2fp%3e%0a%3cp%3eWith%20all%20that%20said%2c%20lets%20add%20the%20following%20to%20our%20%3ccode%3ecargo.toml%3c%2fcode%3e%20file%20to%20get%20the%20%3ccode%3ebacktrace%3c%2fcode%3e%20crate%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-toml%22%20data-lang%3d%22toml%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%5b%3cspan%20style%3d%22color%3a%23a6e22e%22%3edependencies%3c%2fspan%3e%5d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23a6e22e%22%3ebacktrace%3c%2fspan%3e%20%3d%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b0.3.66%26%2334%3b%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eThen%20in%20the%20guarded%20section%20of%20our%20%3ccode%3ealloc%3c%2fcode%3e%20%20function%20we%26rsquo%3bre%20going%20to%20capture%20a%20%3ccode%3ebacktrace%3c%2fcode%3e%2c%20step%20through%20all%20the%20stack%20frames%2c%20and%20pull%20out%20the%20information%20we%26rsquo%3bre%20looking%20for.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Don%26%2339%3bt%20forget%20to%20import%20Backtrace%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3euse%3c%2fspan%3e%20backtrace%3a%3aBacktrace%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20A%20global%20value%20we%20can%20use%20if%20we%20don%26%2339%3bt%20find%20the%20values%20we%26%2339%3bre%20looking%20for%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3econst%3c%2fspan%3e%20UNKNOWN%3a%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3e%26amp%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3estr%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%26lt%3bunknown%26gt%3b%26%2334%3b%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eunsafe%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efn%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3ealloc%3c%2fspan%3e%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3eself%2c%20layout%3a%20%3cspan%20style%3d%22color%3a%23a6e22e%22%3eLayout%3c%2fspan%3e%29%20-%26gt%3b%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%2a%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3eu8%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20ptr%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20self.%3cspan%20style%3d%22color%3a%23ae81ff%22%3e0.%3c%2fspan%3ealloc%28layout%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%21%3c%2fspan%3eGUARD%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09GUARD%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3etrue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20bt%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20Backtrace%3a%3anew%28%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3efor%3c%2fspan%3e%20frame%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3ein%3c%2fspan%3e%20bt.frames%28%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3efor%3c%2fspan%3e%20symbol%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3ein%3c%2fspan%3e%20frame.symbols%28%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Here%20we%20are%20pulling%20out%20the%20name%20of%20the%20function%2c%20in%20which%20file%20%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20the%20function%20can%20be%20found%2c%20and%20the%20line%20number%20where%20the%20%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20allocation%20occurs.%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20name%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20symbol%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.name%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.map%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3en%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20n.to_string%28%29%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.unwrap_or%28UNKNOWN.to_string%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20filename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20symbol%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.filename%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.map%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3ef%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20f.display%28%29.to_string%28%29%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.unwrap_or%28UNKNOWN.to_string%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20lineno%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20symbol%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.lineno%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.map%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3el%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20l.to_string%28%29%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09.unwrap_or%28UNKNOWN.to_string%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09println%21%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%7b%7d%3a%7b%7d%20%7b%7d%20%7b%7d%20bytes%26%2334%3b%3c%2fspan%3e%2c%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09name%2c%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09lineno%2c%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09filename%2c%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%09%09layout.size%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%09%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09GUARD%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09ptr%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eBesides%20the%20nuances%20of%20%3ccode%3ebacktrace%3c%2fcode%3e%20itself%2c%20I%20think%20the%20code%20here%20should%20be%20fairly%20self-explanatory%20for%20those%20with%20some%20familiarity%20with%20Rust.%20There%20are%20some%20definite%20inefficiencies%20with%20our%20implementation%20above%2c%20but%20it%26rsquo%3bll%20do%20for%20our%20purposes%20for%20now.%3c%2fp%3e%0a%3cp%3eRunning%20this%20now%20and%20we%20should%20start%20to%20see%20the%20bigger%20picture%3a%3c%2fp%3e%0a%3cpre%20tabindex%3d%220%22%3e%3ccode%20class%3d%22language-rust_errors%22%20data-lang%3d%22rust_errors%22%3e%26%2334%3bbacktrace%3a%3abacktrace%3a%3adbghelp%3a%3atrace%26%2334%3b%3a98%20%26%2334%3b.cargo%5c%5cregistry%5c%5csrc%5c%5cgithub.com-1ecc6299db9ec823%5c%5cbacktrace-0.3.66%5c%5csrc%5c%5cbacktrace%5c%5cdbghelp.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3bbacktrace%3a%3abacktrace%3a%3atrace_unsynchronized%26lt%3bbacktrace%3a%3acapture%3a%3aimpl%241%3a%3acreate%3a%3aclosure_env%240%26gt%3b%26%2334%3b%3a66%20%26%2334%3b%20.cargo%5c%5cregistry%5c%5csrc%5c%5cgithub.com-1ecc6299db9ec823%5c%5cbacktrace-0.3.66%5c%5csrc%5c%5cbacktrace%5c%5cmod.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3bbacktrace%3a%3abacktrace%3a%3atrace%26lt%3bbacktrace%3a%3acapture%3a%3aimpl%241%3a%3acreate%3a%3aclosure_env%240%26gt%3b%26%2334%3b%3a53%20%26%2334%3b%20.cargo%5c%5cregistry%5c%5csrc%5c%5cgithub.com-1ecc6299db9ec823%5c%5cbacktrace-0.3.66%5c%5csrc%5c%5cbacktrace%5c%5cmod.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3bbacktrace%3a%3acapture%3a%3aBacktrace%3a%3acreate%26%2334%3b%3a176%20%26%2334%3b%20.cargo%5c%5cregistry%5c%5csrc%5c%5cgithub.com-1ecc6299db9ec823%5c%5cbacktrace-0.3.66%5c%5csrc%5c%5ccapture.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3bbacktrace%3a%3acapture%3a%3aBacktrace%3a%3anew%26%2334%3b%3a140%20%26%2334%3b%20.cargo%5c%5cregistry%5c%5csrc%5c%5cgithub.com-1ecc6299db9ec823%5c%5cbacktrace-0.3.66%5c%5csrc%5c%5ccapture.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3balloc%3a%3aimpl%240%3a%3aalloc%26lt%3bstd%3a%3aalloc%3a%3aSystem%26gt%3b%26%2334%3b%3a20%20%26%2334%3brust-bits-and-pieces%5c%5csrc%5c%5calloc.rs%26%2334%3b%205%20bytes%0d%0a%26%2334%3balloc%3a%3a_%3a%3a__rg_alloc%26%2334%3b%3a140%20%26%2334%3brust-bits-and-pieces%5c%5csrc%5c%5calloc.rs%26%2334%3b%205%20bytes%0a%3c%2fcode%3e%3c%2fpre%3e%3cp%3eAnd%20that%20bigger%20picture%20is%20a%20bit%20of%20a%20mess.%3c%2fp%3e%0a%3cp%3eWhat%20we%20have%20here%20is%20the%20full%20path%20that%20our%20code%20traverses%20at%20the%20point%20a%20backtrace%20is%20captured.%20Including%20the%20inner%20functions%20of%20backtrace%20itself%2c%20the%20Rust%20standard%20library%20and%20even%20kernel%2fOS%20level%20calls.%20It%20is%20kind%20of%20hard%20to%20make%20out%20the%20bit%20we%26rsquo%3bre%20interested%20in%2c%20so%20in%20order%20to%20facilitate%20this%20we%26rsquo%3bre%20going%20to%20need%20to%20cut%20back%20a%20lot%20of%20the%20cruft.%3c%2fp%3e%0a%3cp%3eHere%20are%20a%20couple%20of%20conditionals%20we%20can%20add%20to%20the%20code%20block%20to%20remove%20all%20the%20things%20we%26rsquo%3bre%20not%20interested%20in%3a%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Add%20this%20as%20a%20global%20outside%20of%20the%20alloc%20function%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3econst%3c%2fspan%3e%20IGNORED_WORDS%3a%20%5b%3cspan%20style%3d%22color%3a%23f92672%22%3e%26amp%3b%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3estr%3c%2fspan%3e%3b%20%3cspan%20style%3d%22color%3a%23ae81ff%22%3e4%3c%2fspan%3e%5d%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%5b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3binvoke_main%26%2334%3b%3c%2fspan%3e%2c%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b__scrt_common_main_seh%26%2334%3b%3c%2fspan%3e%2c%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3balloc%3a%3a_%3a%3a__rg_alloc%26%2334%3b%3c%2fspan%3e%2c%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bbacktrace%3a%3a%26%2334%3b%3c%2fspan%3e%2c%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%5d%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e..%3c%2fspan%3e.%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Back%20inside%20our%20alloc%20function%20again%2c%20we%20add%20in%20the%20conditionals%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20filename%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20symbol%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.filename%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.map%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3ef%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20f.display%28%29.to_string%28%29%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.unwrap_or%28UNKNOWN.to_string%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20This%20strips%20out%20most%20of%20the%20rust%20std%20library%20code%20and%20anything%20without%20a%20filename%20%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20filename.starts_with%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3b%2frustc%26%2334%3b%3c%2fspan%3e%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%7c%3c%2fspan%3e%20filename.eq%28UNKNOWN%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3econtinue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3elet%3c%2fspan%3e%20name%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20symbol%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.name%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.map%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3en%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20n.to_string%28%29%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.unwrap_or%28UNKNOWN.to_string%28%29%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20And%20this%20strips%20out%20all%20the%20rest%20of%20the%20things%20we%20don%26%2339%3bt%20care%20about%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20IGNORED_WORDS%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.iter%28%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09.any%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3en%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20name.starts_with%28n%29%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%7c%3c%2fspan%3e%20name.ends_with%28n%29%29%20%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%7c%3c%2fspan%3e%20name.contains%28%3cspan%20style%3d%22color%3a%23e6db74%22%3e%26%2334%3bstd%3a%3aalloc%3a%3aSystem%26%2334%3b%3c%2fspan%3e%29%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3econtinue%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%23f92672%22%3e..%3c%2fspan%3e.%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eRunning%20this%20should%20now%20give%20something%20far%20more%20relevant%3a%3c%2fp%3e%0a%3cpre%20tabindex%3d%220%22%3e%3ccode%20class%3d%22language-rust_errors%22%20data-lang%3d%22rust_errors%22%3e%26%2334%3balloc%3a%3amain%26%2334%3b%3a162%20%26%2334%3brust-bits-and-pieces%5c%5csrc%5c%5calloc.rs%26%2334%3b%2015%20bytes%0d%0aHello%2c%20world%21%0a%3c%2fcode%3e%3c%2fpre%3e%3cp%3eSuccess%21%20We%20can%20now%20see%20the%20exact%20spot%20where%20we%20allocated%20our%20string%20in%20%3ccode%3emain%3c%2fcode%3e%20and%20how%20many%20bytes%20were%20allocated.%3c%2fp%3e%0a%3ch2%20id%3d%22bonus-objective-threading%22%3eBonus%20objective%3a%20Threading%3c%2fh2%3e%0a%3cp%3eThere%20is%20one%20major%20problem%20with%20our%20solution.%20It%20isn%26rsquo%3bt%20thread%20safe.%20More%20specifically%20the%20guard%20we%26rsquo%3bre%20using%20isn%26rsquo%3bt%20thread%20safe.%20We%20could%20potentially%20end%20up%20in%20a%20situation%20where%20multiple%20threads%20are%20trying%20to%20allocate%20memory%20at%20the%20same%20time%2c%20and%20one%20of%20those%20threads%20could%20be%20blocked%20by%20the%20guard%20being%20set%2c%20causing%20us%20to%20miss%20reporting%20the%20allocation.%3c%2fp%3e%0a%3cp%3eA%20quick%20way%20to%20resolve%20this%20is%20to%20have%20a%20guard%20for%20each%20thread%2c%20which%20can%20be%20achieved%20quite%20simply%20with%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2fthread%2fstruct.LocalKey.html%22%3ethread_local%20storage%3c%2fa%3e.%20I%20won%26rsquo%3bt%20explain%20the%20intricacies%20of%20thread%20local%20storage%20here%2c%20but%20suffice%20it%20to%20say%20that%20it%20should%20achieve%20our%20stated%20goal%20of%20a%20single%20instance%20of%20%3ccode%3eGUARD%3c%2fcode%3e%20per%20thread.%20Once%20again%2c%20I%20suggest%20you%20read%20up%20a%20little%20about%20it%20after%20this%20exercise%20is%20done.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3ethread_local%21%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%20%20%20%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3estatic%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3emut%3c%2fspan%3e%20GUARD%3a%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3ebool%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%3d%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eUnfortunately%20for%20us%2c%20this%20doesn%26rsquo%3bt%20compile.%20%3ccode%3ethread_local%3c%2fcode%3e%20does%20not%20support%20mutable%20values%2c%20so%20we%26rsquo%3bll%20need%20to%20reach%20for%20a%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2fcell%2findex.html%22%3eCell%3c%2fa%3e.%3c%2fp%3e%0a%3cp%3eThis%20article%20is%20pretty%20long%20already%2c%20so%20I%20won%26rsquo%3bt%20go%20into%20too%20much%20detail%20with%20regards%20to%20how%20%3ccode%3eCell%3c%2fcode%3e%20works%2c%20but%20importantly%20it%20allows%20us%20to%20mutate%20a%20value%20without%20it%20being%20marked%20as%20%3ccode%3emut%3c%2fcode%3e.%20It%20does%20this%20by%20creating%20a%20copy%20of%20the%20value%20in%20the%20%3ccode%3eCell%3c%2fcode%3e%20when%20you%20%3ccode%3eget%3c%2fcode%3e%20it%2c%20and%20replacing%20the%20value%20inside%20when%20you%20%3ccode%3eset%3c%2fcode%3e%20it%2c%20rather%20than%20sharing%20the%20underlying%20value%20around.%20The%20linked%20documentation%20on%20%3ccode%3eCell%3c%2fcode%3e%20is%20pretty%20good%2c%20and%20you%20should%20definitely%20give%20it%20a%20read%20if%20you%20are%20going%20to%20be%20doing%20Rust%20in%20any%20serious%20capacity.%3c%2fp%3e%0a%3cdiv%20class%3d%22highlight%22%3e%3cpre%20tabindex%3d%220%22%20style%3d%22color%3a%23f8f8f2%3bbackground-color%3a%23272822%3b-moz-tab-size%3a4%3b-o-tab-size%3a4%3btab-size%3a4%3b%22%3e%3ccode%20class%3d%22language-rust%22%20data-lang%3d%22rust%22%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3eGUARD.with%28%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3eguard%3cspan%20style%3d%22color%3a%23f92672%22%3e%7c%3c%2fspan%3e%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%3cspan%20style%3d%22color%3a%2366d9ef%22%3eif%3c%2fspan%3e%20%3cspan%20style%3d%22color%3a%23f92672%22%3e%21%3c%2fspan%3eguard.get%28%29%20%7b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09guard.set%28%3cspan%20style%3d%22color%3a%2366d9ef%22%3etrue%3c%2fspan%3e%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09%3cspan%20style%3d%22color%3a%2375715e%22%3e%2f%2f%20Guarded%20code%20goes%20in%20here%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%3cspan%20style%3d%22color%3a%2375715e%22%3e%3c%2fspan%3e%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%09guard.set%28%3cspan%20style%3d%22color%3a%2366d9ef%22%3efalse%3c%2fspan%3e%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%09%7d%0a%3c%2fspan%3e%3c%2fspan%3e%3cspan%20style%3d%22display%3aflex%3b%22%3e%3cspan%3e%7d%29%3b%0a%3c%2fspan%3e%3c%2fspan%3e%3c%2fcode%3e%3c%2fpre%3e%3c%2fdiv%3e%3cp%3eWith%20that%20change%20in%20we%2c%20things%20should%20work%20the%20same%20as%20they%20did%20before%2c%20except%20that%20you%26rsquo%3bll%20get%20slightly%20less%20buggy%20behaviour%20in%20a%20threaded%20environment.%3c%2fp%3e%0a%3cp%3eOnce%20again%20there%20are%20likely%20better%20and%20more%20efficient%20ways%20to%20solve%20this%20problem.%20Writing%20to%20STDOUT%20during%20a%20performance%20critical%20section%20of%20your%20code%20is%20definitely%20going%20to%20suffer%20using%20this%20allocator%2c%20but%20as%20a%20simple%20learning%20exercise%20this%20will%20do%20fine.%20However%2c%20if%20want%20to%20identify%20some%20simple%20places%20where%20allocations%20are%20taking%20place%20in%20your%20code%2c%20this%20should%20do%20the%20job.%3c%2fp%3e%0a%3cp%3eCongratulations%2c%20you%20did%20it%21%3c%2fp%3e%0a%3cp%3e%3cem%3eOnce%20again%2c%20%3ca%20href%3d%22https%3a%2f%2fgist.github.com%2fshiver%2f87ccd945ea62626ed40531b974988da6%22%3ehere%3c%2fa%3e%20is%20the%20final%20implementation%20for%20you%20to%20review.%3c%2fem%3e%3c%2fp%3e%0a%3ch2%20id%3d%22conclusion%22%3eConclusion%3c%2fh2%3e%0a%3cp%3eIf%20you%20take%20a%20look%20at%20the%20final%20implementation%20there%20really%20isn%26rsquo%3bt%20that%20much%20code%20here.%20Yes%20it%20isn%26rsquo%3bt%20very%20efficient%2c%20and%20sure%20it%20doesn%26rsquo%3bt%20cover%20every%20scenario%2c%20but%20if%20your%20goal%20is%20to%20actually%20learn%20and%20take%20on%20this%20information%2c%20this%20exercise%20will%20hopefully%20have%20helped%20in%20that%20regard.%3c%2fp%3e%0a%3cp%3eFor%20mission%20critical%20projects%20you%20can%20certainly%20find%20a%20more%20complete%20solution%2c%20but%20if%20you%26rsquo%3bre%20just%20working%20on%20a%20hobby%20project%2c%20or%20experimenting%2c%20making%20your%20own%20will%20give%20a%20healthy%20dose%20of%20perspective%2c%20and%20perhaps%20a%20greater%20appreciation%20for%20how%20simple%20or%20hard%20things%20actually%20are.%3c%2fp%3e%0a%3chr%3e%0a%3ch2%20id%3d%22references%22%3eReferences%3c%2fh2%3e%0a%3cul%3e%0a%3cli%3eThe%20%3ca%20href%3d%22https%3a%2f%2fdocs.rs%2fbacktrace%2f0.3.66%2fbacktrace%2f%22%3edocumentation%3c%2fa%3e%20and%20%3ca%20href%3d%22https%3a%2f%2fgithub.com%2frust-lang%2fbacktrace-rs%22%3esource%3c%2fa%3e%20for%20the%20backtrace%20crate%3c%2fli%3e%0a%3cli%3eRust%20documentation%20for%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2falloc%2findex.html%22%3estd%3a%3aalloc%3c%2fa%3e%3c%2fli%3e%0a%3cli%3eRust%20documentation%20for%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2falloc%2fstruct.Layout.html%22%3eLayout%3c%2fa%3e%3c%2fli%3e%0a%3cli%3eRust%20documentation%20for%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2fcell%2findex.html%22%3eCell%3c%2fa%3e%3c%2fli%3e%0a%3cli%3eRust%20documentation%20for%20%3ca%20href%3d%22https%3a%2f%2fdoc.rust-lang.org%2fstd%2fthread%2fstruct.LocalKey.html%22%3ethread_local%20storage%3c%2fa%3e%3c%2fli%3e%0a%3cli%3e%3ca%20href%3d%22https%3a%2f%2fwww.jamesgolick.com%2f2013%2f5%2f15%2fmemory-allocators-101.html%22%3eArticle%3c%2fa%3e%20by%20James%20Golick%20on%20how%20memory%20allocators%20work%20under%20the%20hood%3c%2fli%3e%0a%3cli%3eRust%26rsquo%3bs%20%3ca%20href%3d%22https%3a%2f%2frustc-dev-guide.rust-lang.org%2fborrow_check.html%22%3esecret%20sauce%3c%2fa%3e%3c%2fli%3e%0a%3c%2ful%3e%0a" title="Share via Email" target="_blank"><span class="fa fa-envelope fa-2x" aria-hidden="true"></span></a>
</div>
    
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; 2022 | Follow on <a class="follow-item" href="https://twitter.com/shivernz" target="_blank">Twitter</a> | <a class="follow-item" href="https://github.com/shiver" target="_blank">GitHub</a></p>
  </div>
</section>


<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js" integrity="sha512-gU7kztaQEl7SHJyraPfZLQCNnrKdaQi5ndOyt4L4UPL/FHDd/uB9Je6KDARIqwnNNE27hnqoWLBq+Kpe4iHfeQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/c.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/cpp.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/csharp.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/rust.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/python.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/php.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/javascript.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/css.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/languages/typescript.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146427172-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
